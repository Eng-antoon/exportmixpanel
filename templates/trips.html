{% extends "layout.html" %}
{% block content %}
<style>
  /* Ensure the table headers remain visible while scrolling horizontally */
  .table-container {
    width: 100%;
    overflow-x: auto;
  }
  .custom-table {
    min-width: 1800px;
    border-collapse: separate;
    border-spacing: 0;
  }
  .custom-table th,
  .custom-table td {
    white-space: nowrap;
    padding: 0.5rem;
    border: 1px solid #ddd;
  }
  /* Sticky header */
  .custom-table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 10;
  }
  /* Sticky first column (Trip ID) */
  .custom-table th:first-child,
  .custom-table td:first-child {
    position: sticky;
    left: 0;
    background: #f8f9fa;
    z-index: 11;
  }
</style>

<div class="card mb-4 animate__animated animate__fadeInUp">
  <div class="card-body">
    <h2 class="card-title">Trips</h2>
    <form class="row g-3" method="GET" action="{{ url_for('trips') }}">
      <div class="col-md-2">
        <input type="text" name="trip_id" class="form-control" placeholder="Trip ID" value="{{ trip_id_search }}" />
      </div>
      <div class="col-md-2">
        <select name="route_quality" class="form-select">
          <option value="">-- Route Quality --</option>
          <option value="Not Assigned" {% if route_quality_filter|lower == "not assigned" %}selected{% endif %}>Not Assigned</option>
          <option value="No Logs Trips" {% if route_quality_filter == "No Logs Trips" %}selected{% endif %}>No Logs Trips</option>
          <option value="Trip Points Only Exist" {% if route_quality_filter == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
          <option value="Low" {% if route_quality_filter == "Low" %}selected{% endif %}>Low</option>
          <option value="Moderate" {% if route_quality_filter == "Moderate" %}selected{% endif %}>Moderate</option>
          <option value="High" {% if route_quality_filter == "High" %}selected{% endif %}>High</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" name="model" class="form-control" placeholder="Model" value="{{ model_filter }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="ram" class="form-control" placeholder="RAM" value="{{ ram_filter }}" />
      </div>
      <div class="col-md-2">
        <select name="carrier" class="form-select">
          <option value="">-- Select Carrier --</option>
          {% for c in carriers_for_dropdown %}
          <option value="{{ c }}" {% if c == carrier_filter %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" name="variance_min" class="form-control" placeholder="Variance Min (%)" value="{{ variance_min }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="variance_max" class="form-control" placeholder="Variance Max (%)" value="{{ variance_max }}" />
      </div>
      <div class="col-md-2">
        <select name="driver" class="form-select">
          <option value="">-- Select Driver --</option>
          {% for d in drivers %}
          <option value="{{ d }}" {% if d == driver_filter %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- New Row: Trip Time Range -->
      <div class="col-md-2">
        <input type="text" name="trip_time_min" class="form-control" placeholder="Trip Time Min (h)" value="{{ request.args.get('trip_time_min','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="trip_time_max" class="form-control" placeholder="Trip Time Max (h)" value="{{ request.args.get('trip_time_max','') }}" />
      </div>
      <!-- Existing Trip Time Operator and Single Value Filter -->
      <div class="col-md-2">
        <select name="trip_time_op" class="form-select">
          <option value="equal" {% if request.args.get('trip_time_op','equal') == "equal" %}selected{% endif %}>equal</option>
          <option value="less than" {% if request.args.get('trip_time_op','equal') == "less than" %}selected{% endif %}>less than</option>
          <option value="more than" {% if request.args.get('trip_time_op','equal') == "more than" %}selected{% endif %}>more than</option>
          <option value="less than or equal" {% if request.args.get('trip_time_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
          <option value="more than or equal" {% if request.args.get('trip_time_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
        </select>
        <input type="text" name="trip_time" class="form-control" placeholder="Trip Time (h)" value="{{ request.args.get('trip_time','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="completed_by" class="form-control" placeholder="Completed By" value="{{ request.args.get('completed_by','') }}" />
      </div>
      <!-- New Row: Log Count Range -->
      <div class="col-md-2">
        <input type="text" name="log_count_min" class="form-control" placeholder="Log Count Min" value="{{ request.args.get('log_count_min','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="log_count_max" class="form-control" placeholder="Log Count Max" value="{{ request.args.get('log_count_max','') }}" />
      </div>
      <!-- Existing Log Count Operator and Single Value Filter -->
      <div class="col-md-2">
        <select name="log_count_op" class="form-select">
          <option value="equal" {% if request.args.get('log_count_op','equal') == "equal" %}selected{% endif %}>equal</option>
          <option value="less than" {% if request.args.get('log_count_op','equal') == "less than" %}selected{% endif %}>less than</option>
          <option value="more than" {% if request.args.get('log_count_op','equal') == "more than" %}selected{% endif %}>more than</option>
          <option value="less than or equal" {% if request.args.get('log_count_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
          <option value="more than or equal" {% if request.args.get('log_count_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
        </select>
        <input type="text" name="log_count" class="form-control" placeholder="Log Count" value="{{ request.args.get('log_count','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="status" class="form-control" placeholder="Status" value="{{ request.args.get('status','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="export_name" class="form-control" placeholder="Export Name" value="{{ request.args.get('export_name','exported_trips') }}" />
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
      <div class="col-md-2">
        <a href="{{ url_for('export_trips', trip_id=trip_id_search, route_quality=route_quality_filter, model=model_filter, ram=ram_filter, carrier=carrier_filter, variance_min=variance_min, variance_max=variance_max, driver=driver_filter, export_name=request.args.get('export_name','exported_trips')) }}" class="btn btn-success w-100">Export XLSX</a>
      </div>
    </form>
  </div>
</div>

<div class="card mb-4 animate__animated animate__fadeInUp">
  <div class="card-body table-container">
    <table class="table table-bordered custom-table">
      <thead class="table-light">
        <tr>
          <th>Driver</th>
          <th>Carrier</th>
          <th>Android Ver</th>
          <th>Model</th>
          <th>Device Name</th>
          <th>Chipset</th>
          <th>RAM</th>
          <th>Storage</th>
          <th>Background Tendency</th>
          <th>Manufacturer</th>
          <th>Manual Dist</th>
          <th>Calc Dist</th>
          <th>% Calc/Manual</th>
          <th>Variance (%)</th>
          <th>Trip ID</th>
          <th>Route Quality</th>
          <th>Trip Time (h)</th>
          <th>Completed By</th>
          <th>Log Count</th>
          <th>Status</th>
          <th>View Details</th>
        </tr>
      </thead>
      <tbody>
        {% for trip in trips %}
        <tr>
          <td>{{ trip.UserName }}</td>
          <td>{{ trip.carrier }}</td>
          <td>{{ trip["Android Version"] }}</td>
          <td>{{ trip.model }}</td>
          <td>{{ trip["Device Name"] }}</td>
          <td>{{ trip.Chipset }}</td>
          <td>{{ trip.RAM }}</td>
          <td>{{ trip.Storage }}</td>
          <td>{{ trip["Background Task Killing Tendency"] }}</td>
          <td>{{ trip.manufacturer }}</td>
          <td>{{ trip.manual_distance }}</td>
          <td>{{ trip.calculated_distance }}</td>
          <td>{{ trip.distance_percentage }}</td>
          <td>
            {% if trip.variance is not none %}
              {{ trip.variance|round(2) }}%
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            <a href="https://backoffice.illa.blue/database/trips/{{ trip.tripId }}" target="_blank">{{ trip.tripId }}</a>
          </td>
          <td>
            <select class="form-select route-quality-select" data-trip-id="{{ trip.tripId }}">
              <option value="">-- Select --</option>
              <option value="No Logs Trips" {% if trip.route_quality == "No Logs Trips" %}selected{% endif %}>No Logs Trips</option>
              <option value="Trip Points Only Exist" {% if trip.route_quality == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
              <option value="Low" {% if trip.route_quality == "Low" %}selected{% endif %}>Low</option>
              <option value="Moderate" {% if trip.route_quality == "Moderate" %}selected{% endif %}>Moderate</option>
              <option value="High" {% if trip.route_quality == "High" %}selected{% endif %}>High</option>
            </select>
          </td>
          <td>{{ trip.trip_time if trip.trip_time is not none else 'N/A' }}</td>
          <td>{{ trip.completed_by if trip.completed_by is not none else 'N/A' }}</td>
          <td>{{ trip.coordinate_count if trip.coordinate_count != "" else 'N/A' }}</td>
          <td>{{ trip.status if trip.status is not none else 'N/A' }}</td>
          <td>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('trip_detail', trip_id=trip.tripId) }}">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-center mt-3">
    <p class="mb-0">Showing page {{ page }} of {{ total_pages }} ({{ total_rows }} total rows)</p>
    <div>
      {% if page > 1 %}
        <a class="btn btn-secondary btn-sm" href="?page={{ page-1 }}&trip_id={{ trip_id_search }}&route_quality={{ route_quality_filter }}&model={{ model_filter }}&ram={{ ram_filter }}&carrier={{ carrier_filter }}&variance_min={{ variance_min }}&variance_max={{ variance_max }}&driver={{ driver_filter or '' }}&trip_time_min={{ request.args.get('trip_time_min','') }}&trip_time_max={{ request.args.get('trip_time_max','') }}&trip_time={{ request.args.get('trip_time','') }}&trip_time_op={{ request.args.get('trip_time_op','equal') }}&completed_by={{ request.args.get('completed_by','') }}&log_count_min={{ request.args.get('log_count_min','') }}&log_count_max={{ request.args.get('log_count_max','') }}&log_count={{ request.args.get('log_count','') }}&log_count_op={{ request.args.get('log_count_op','equal') }}&status={{ request.args.get('status','') }}">
          Previous
        </a>
      {% endif %}
      {% if page < total_pages %}
        <a class="btn btn-secondary btn-sm" href="?page={{ page+1 }}&trip_id={{ trip_id_search }}&route_quality={{ route_quality_filter }}&model={{ model_filter }}&ram={{ ram_filter }}&carrier={{ carrier_filter }}&variance_min={{ variance_min }}&variance_max={{ variance_max }}&driver={{ driver_filter or '' }}&trip_time_min={{ request.args.get('trip_time_min','') }}&trip_time_max={{ request.args.get('trip_time_max','') }}&trip_time={{ request.args.get('trip_time','') }}&trip_time_op={{ request.args.get('trip_time_op','equal') }}&completed_by={{ request.args.get('completed_by','') }}&log_count_min={{ request.args.get('log_count_min','') }}&log_count_max={{ request.args.get('log_count_max','') }}&log_count={{ request.args.get('log_count','') }}&log_count_op={{ request.args.get('log_count_op','equal') }}&status={{ request.args.get('status','') }}">
          Next
        </a>
      {% endif %}
    </div>
  </div>
</div>
<script>
document.querySelectorAll('.route-quality-select').forEach(function(selectElem) {
  selectElem.addEventListener('change', function() {
    const tripId = this.getAttribute('data-trip-id');
    const selectedQuality = this.value;
    if (!selectedQuality) return;
    fetch('/update_route_quality', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trip_id: tripId, route_quality: selectedQuality })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        console.log('Route quality updated for trip ' + tripId);
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while updating route quality.');
    });
  });
});
</script>
{% endblock %}
